<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Sebaran Laporan</title>
    
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
        body { display: flex; flex-direction: column; background: var(--dark); }
        .app-header { flex: 0 0 auto; z-index: 2000; }
        #map-wrapper { flex: 1 1 auto; position: relative; width: 100%; background: #ddd; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .bottom-nav { flex: 0 0 auto; z-index: 2000; }

        .map-stats {
            position: absolute; bottom: 10px; left: 10px;
            background: white; padding: 8px 12px; border-radius: 8px;
            font-size: 11px; font-weight: bold; z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .legend {
            position: absolute; bottom: 10px; right: 10px;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 900;
            font-size: 10px; max-width: 140px;
        }
        .legend strong { display: block; margin-bottom: 8px; font-size: 11px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-dot {
            width: 12px; height: 12px; border-radius: 50%; margin-right: 6px;
            flex-shrink: 0; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 2000; color: white; font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="app-header">
        <a href="../../index.html" class="header-icon"><i class="fas fa-arrow-left"></i></a>
        <h1>PETA SEBARAN</h1>
        <div class="header-icon"></div>
    </div>

    <div id="map-wrapper">
        <div id="map"></div>

        <div id="loading" class="loading">
            <div><i class="fas fa-spinner fa-spin"></i> Memuat Data...</div>
        </div>

        <div class="map-stats">
            <span id="statsText">Memuat...</span>
        </div>

        <div class="legend">
            <strong>üìç Kategori</strong>
            <div class="legend-item">
                <div class="legend-dot" style="background: #d32f2f;"></div>
                <span>Bencana</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f57c00;"></div>
                <span>Infrastruktur</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #0288d1;"></div>
                <span>Banjir</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #7b1fa2;"></div>
                <span>Kamtibmas</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #388e3c;"></div>
                <span>Lainnya</span>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="../../index.html" class="nav-item"><i class="fas fa-house"></i>Home</a>
        <a href="index.html" class="nav-item active"><i class="fas fa-map-location-dot"></i>Peta</a>
        <a href="../operator/index.html" class="nav-item"><i class="fas fa-plus-circle"></i>Lapor</a>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([1.68, 101.44], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        setTimeout(() => map.invalidateSize(), 300);

        const COLORS = {
            "Bencana": "#d32f2f", "Infrastruktur": "#f57c00", "Banjir": "#0288d1",
            "Kamtibmas": "#7b1fa2", "Lainnya": "#388e3c"
        };

        async function loadData() {
            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec");
                const json = await res.json();
                const data = json.laporan || [];
                
                console.log(`‚úÖ Loaded ${data.length} laporan`);
                
                if(data.length === 0) {
                    alert("Data kosong");
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // DEBUG: Print semua kolom dari row pertama
                console.log("üîç DEBUG KOLOM:");
                data[0].forEach((col, idx) => {
                    console.log(`  [${idx}] = "${col}"`);
                });

                let markerCount = 0;

                data.forEach((row, idx) => {
                    // CARI kolom yang mengandung koordinat
                    let lat, lng, lokasi = "";
                    
                    for(let i = 0; i < row.length; i++) {
                        const col = String(row[i] || "");
                        
                        // Cari pattern koordinat di kolom manapun
                        let match = col.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                        if(!match) match = col.match(/place\/(-?\d+\.\d+),(-?\d+\.\d+)/);
                        if(!match) match = col.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
                        
                        if(match) {
                            lat = parseFloat(match[1]);
                            lng = parseFloat(match[2]);
                            lokasi = col;
                            console.log(`‚úì Row ${idx}: Found coords in column [${i}]`);
                            break;
                        }
                    }

                    if(!lat || !lng || isNaN(lat) || isNaN(lng)) {
                        console.warn(`‚ö†Ô∏è Row ${idx}: No valid coords found`);
                        return;
                    }

                    // Ambil data lain
                    const timestamp = row[0] || "";
                    const nama = row[1] || "Pelapor";
                    const kat = row[2] || "Lainnya";
                    const foto = row[4] || "";

                    const color = COLORS[kat] || COLORS["Lainnya"];
                    
                    const icon = L.divIcon({
                        className: '',
                        html: `<div style="background:${color};width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 3px 6px rgba(0,0,0,0.5);"></div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    const marker = L.marker([lat, lng], {icon: icon})
                        .bindPopup(`
                            <div style="width:200px;font-size:11px;line-height:1.4;">
                                <b style="color:${color};font-size:13px;">${kat}</b><br>
                                <small style="color:#888">${timestamp}</small><br>
                                <strong>${nama}</strong>
                                ${foto ? `<img src="${foto}" style="width:100%;height:100px;object-fit:cover;border-radius:4px;margin:8px 0;background:#eee;" onerror="this.style.display='none'">` : ''}
                                <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="display:block;background:${color};color:white;text-align:center;padding:6px;border-radius:4px;text-decoration:none;margin-top:8px;font-weight:600;">
                                    <i class="fas fa-map-marker-alt"></i> Buka Maps
                                </a>
                            </div>
                        `);
                    
                    marker.addTo(map);
                    markerCount++;
                });

                console.log(`‚úÖ ${markerCount} markers rendered`);
                
                document.getElementById('statsText').innerText = `${markerCount} Laporan Ditampilkan`;
                document.getElementById('loading').style.display = 'none';

                // Auto zoom
                if(markerCount > 0) {
                    setTimeout(() => {
                        const bounds = [];
                        map.eachLayer(layer => {
                            if(layer instanceof L.Marker) {
                                bounds.push(layer.getLatLng());
                            }
                        });
                        if(bounds.length > 0) {
                            map.fitBounds(L.latLngBounds(bounds).pad(0.1), {maxZoom: 15});
                        }
                    }, 500);
                } else {
                    alert("‚ùå Tidak ada marker yang bisa ditampilkan.\n\nPastikan data laporan memiliki koordinat GPS!");
                }

            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        loadData();
    </script>
</body>
</html>

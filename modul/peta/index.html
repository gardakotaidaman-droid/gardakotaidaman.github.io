<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Sebaran Laporan</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Layout Fix: Header - Map - Navbar */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: var(--dark);
        }

        .app-header {
            flex-shrink: 0;
            z-index: 2000;
        }

        #map-wrapper {
            flex-grow: 1;
            position: relative;
            width: 100%;
            background: #ddd;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .bottom-nav {
            flex-shrink: 0;
            z-index: 2000;
        }

        /* Filter Panel (Floating) */
        .filter-toggle {
            position: absolute;
            top: 10px; left: 10px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-panel {
            position: absolute;
            top: 50px; left: 10px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .hidden {
            transform: translateY(-20px);
            opacity: 0;
            pointer-events: none;
        }

        .filter-group { margin-bottom: 10px; }
        .filter-group label { display: block; font-size: 10px; font-weight: bold; color: #666; margin-bottom: 3px; }
        .filter-group select, .filter-group input {
            width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px;
        }

        /* Stats & Legend */
        .map-stats {
            position: absolute; bottom: 10px; left: 10px;
            background: white; padding: 5px 10px; border-radius: 5px;
            font-size: 10px; font-weight: bold; z-index: 900;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Popup Styling */
        .popup-content { width: 180px; font-size: 11px; }
        .popup-content img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin: 5px 0; background: #eee; }
        .btn-maps { display: block; background: var(--primary); color: white; text-align: center; padding: 5px; border-radius: 3px; text-decoration: none; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- 1. HEADER -->
    <div class="app-header">
        <a href="../../index.html" class="header-icon"><i class="fas fa-arrow-left"></i></a>
        <h1>PETA SEBARAN</h1>
        <div class="header-icon"></div>
    </div>

    <!-- 2. MAP AREA -->
    <div id="map-wrapper">
        <div id="map"></div>

        <!-- Tombol Filter -->
        <button class="filter-toggle" onclick="toggleFilter()">
            <i class="fas fa-filter"></i> Filter
        </button>

        <!-- Panel Filter -->
        <div id="filterPanel" class="filter-panel">
            <div class="filter-group">
                <label>MINGGU KE-</label>
                <select id="fWeek"><option value="all">Semua Data</option></select>
            </div>
            <div class="filter-group">
                <label>KATEGORI</label>
                <select id="fKat"><option value="all">Semua Kategori</option></select>
            </div>
            <div class="filter-group">
                <label>CARI</label>
                <input type="text" id="fSearch" placeholder="Lokasi / Pelapor..." onkeyup="render()">
            </div>
            <div style="text-align:right; font-size:10px; color:#666">
                <span id="countDisplay">0</span> data ditemukan
            </div>
        </div>

        <!-- Stats Kecil -->
        <div class="map-stats">
            Total Laporan: <span id="totalAll" style="color:var(--primary)">0</span>
        </div>
    </div>

    <!-- 3. NAVBAR (TETAP ADA) -->
    <nav class="bottom-nav">
        <a href="../../index.html" class="nav-item"><i class="fas fa-house"></i>Home</a>
        <a href="index.html" class="nav-item active"><i class="fas fa-map-location-dot"></i>Peta</a>
        <a href="../operator/index.html" class="nav-item"><i class="fas fa-plus-circle"></i>Lapor</a>
    </nav>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIG & UTILS ---
        const map = L.map('map').setView([1.68, 101.44], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let RAW_DATA = [];
        let MARKERS = [];
        const COLORS = {
            "Bencana": "red", "Infrastruktur": "orange", "Banjir": "blue",
            "Kamtibmas": "purple", "Lainnya": "gray"
        };

        function toggleFilter() {
            document.getElementById('filterPanel').classList.toggle('hidden');
        }

        function getWeekStr(dateStr) {
            try {
                if(!dateStr) return "Unknown";
                let d;
                if(dateStr.includes('/')) {
                    const [day, month, year] = dateStr.split(' ')[0].split('/');
                    d = new Date(`${year}-${month}-${day}`);
                } else {
                    d = new Date(dateStr);
                }
                if(isNaN(d)) return "Unknown";
                
                // Hitung Minggu
                const oneJan = new Date(d.getFullYear(),0,1);
                const numberOfDays = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
                const week = Math.ceil((d.getDay() + 1 + numberOfDays) / 7);
                return `Minggu ${week} (${d.getFullYear()})`;
            } catch(e) { return "Unknown"; }
        }

        // --- MAIN LOGIC ---
        async function loadData() {
            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbwCKYJOQyULCxf5skOQ5AC9BpgR9beG3Uw3M1iMTEOoUgkRPvtGlybwK9iz19PGD0P5ww/exec");
                const json = await res.json();
                RAW_DATA = json.laporan || [];

                // 1. Populate Filters
                const weeks = new Set();
                const cats = new Set();
                
                RAW_DATA.forEach(row => {
                    weeks.add(getWeekStr(row[0]));
                    cats.add(row[2]);
                });

                const fWeek = document.getElementById('fWeek');
                Array.from(weeks).sort().reverse().forEach(w => {
                    let opt = document.createElement('option');
                    opt.value = w; opt.text = w; fWeek.appendChild(opt);
                });

                const fKat = document.getElementById('fKat');
                Array.from(cats).sort().forEach(c => {
                    let opt = document.createElement('option');
                    opt.value = c; opt.text = c; fKat.appendChild(opt);
                });

                document.getElementById('totalAll').innerText = RAW_DATA.length;
                render();

            } catch(e) { console.error(e); }
        }

        function render() {
            MARKERS.forEach(m => map.removeLayer(m));
            MARKERS = [];

            const w = document.getElementById('fWeek').value;
            const k = document.getElementById('fKat').value;
            const s = document.getElementById('fSearch').value.toLowerCase();
            let count = 0;

            RAW_DATA.forEach(row => {
                const [time, nama, kat, locRaw, foto, ket] = row;
                
                // Filter Logic
                if (w !== 'all' && getWeekStr(time) !== w) return;
                if (k !== 'all' && kat !== k) return;
                
                const txt = (locRaw + " " + nama + " " + (ket||"")).toLowerCase();
                if (s && !txt.includes(s)) return;

                // Marker Logic
                const coord = locRaw.match(/(-?\d+\.\d+),(-?\d+\.\d+)/);
                if (!coord) return;

                const lat = parseFloat(coord[1]);
                const lng = parseFloat(coord[2]);
                const color = COLORS[kat] || "gray";

                const icon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)"></div>`
                });

                const marker = L.marker([lat, lng], {icon: icon})
                    .bindPopup(`
                        <div class="popup-content">
                            <b style="color:${color}">${kat}</b><br>
                            <small>${time}</small><br>
                            <b>${nama}</b>
                            ${foto ? `<img src="${foto}">` : ''}
                            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn-maps">Buka Maps</a>
                        </div>
                    `);
                
                marker.addTo(map);
                MARKERS.push(marker);
                count++;
            });

            document.getElementById('countDisplay').innerText = count;
            
            if(MARKERS.length > 0) {
                const group = new L.featureGroup(MARKERS);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        document.getElementById('fWeek').addEventListener('change', render);
        document.getElementById('fKat').addEventListener('change', render);

        loadData();
    </script>
</body>
</html>
